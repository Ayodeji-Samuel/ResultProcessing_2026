{% extends "base.html" %}

{% block title %}{{ course.course_code }} Results - Result Processing System{% endblock %}

{% block content %}
<!-- Approval Status Banner -->
{% set locked_count = results|selectattr('is_locked', 'equalto', True)|list|length %}
{% set total_results = results|length %}

{% if course.is_approved %}
<div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl shadow-lg p-6 mb-6 border-2 border-green-400">
    <div class="flex items-center justify-between text-white">
        <div class="flex items-center">
            <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                <i class="ri-shield-check-fill text-3xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-1">Final Approval Granted</h2>
                <p class="text-green-100">Approved by {{ course.approver.full_name if course.approver else 'HoD' }} on {{ course.approved_at.strftime('%B %d, %Y at %I:%M %p') if course.approved_at else 'N/A' }}</p>
            </div>
        </div>
        <div class="text-right">
            <span class="px-4 py-2 bg-white text-green-600 rounded-lg font-bold text-sm">OFFICIALLY APPROVED</span>
        </div>
    </div>
</div>
{% elif locked_count > 0 %}
<div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl shadow-lg p-6 mb-6 border-2 border-amber-400">
    <div class="flex items-center justify-between text-white">
        <div class="flex items-center">
            <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                <i class="ri-lock-fill text-3xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-1">Results Locked - Awaiting HoD Final Approval</h2>
                <p class="text-amber-100">{{ locked_count }} of {{ total_results }} results have been approved by lecturer(s)</p>
            </div>
        </div>
        <div class="flex gap-3">
            {% if current_user.is_hod() %}
                {% if locked_count == total_results %}
                <form action="{{ url_for('results.final_approve_course', course_id=course.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to give FINAL APPROVAL for this course? This signifies departmental board approval.');">
                    <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-bold flex items-center shadow-lg">
                        <i class="ri-shield-check-line mr-2 text-xl"></i> Give Final Approval
                    </button>
                </form>
                {% endif %}
                <form action="{{ url_for('results.unlock_course_results', course_id=course.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to unlock these results? This will allow lecturers to make changes.');">
                    <button type="submit" class="px-6 py-3 bg-white text-amber-600 rounded-lg hover:bg-amber-50 transition-all font-bold flex items-center shadow-lg">
                        <i class="ri-lock-unlock-line mr-2 text-xl"></i> Unlock Results
                    </button>
                </form>
            {% else %}
                <span class="px-4 py-2 bg-white text-amber-600 rounded-lg font-bold text-sm">LOCKED - AWAITING HOD</span>
            {% endif %}
        </div>
    </div>
</div>
{% elif total_results > 0 %}
<div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl shadow-lg p-6 mb-6 border-2 border-blue-400">
    <div class="flex items-center justify-between text-white">
        <div class="flex items-center">
            <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                <i class="ri-draft-line text-3xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-1">Draft Results - Pending Approval</h2>
                <p class="text-blue-100">Results can still be edited. Click "Approve Results" when ready to lock for review.</p>
            </div>
        </div>
        <div>
            <form action="{{ url_for('results.approve_course_results', course_id=course.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to approve these results? You will not be able to make further changes unless unlocked by HoD.');">
                <button type="submit" class="px-6 py-3 bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-all font-bold flex items-center shadow-lg">
                    <i class="ri-check-double-line mr-2 text-xl"></i> Approve Results
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Header with gradient background -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-between items-start">
        <div class="text-white">
            <div class="flex items-center mb-2">
                <i class="ri-bar-chart-box-line text-3xl mr-3"></i>
                <h1 class="text-2xl font-bold">{{ course.course_code }} - {{ course.course_title }}</h1>
            </div>
            <div class="flex items-center space-x-4 text-blue-100">
                <span class="flex items-center">
                    <i class="ri-graduation-cap-line mr-2"></i>
                    {{ course.program }}
                </span>
                <span class="text-blue-200">|</span>
                <span class="flex items-center">
                    <i class="ri-stack-line mr-1"></i>
                    {{ course.level }} Level
                </span>
                <span class="text-blue-200">|</span>
                <span class="flex items-center">
                    <i class="ri-calendar-line mr-1"></i>
                    {{ 'First' if course.semester == 1 else 'Second' }} Semester
                </span>
                <span class="text-blue-200">|</span>
                <span class="flex items-center">
                    <i class="ri-medal-line mr-1"></i>
                    {{ course.credit_unit }} Credit Units
                </span>
            </div>
        </div>
        <div class="flex gap-3">
            {% if locked_count > 0 and not current_user.is_hod() %}
            <button class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg cursor-not-allowed flex items-center font-medium" disabled title="Results are locked">
                <i class="ri-lock-line mr-2"></i> Results Locked
            </button>
            {% else %}
            <a href="{{ url_for('results.manual_entry', course_id=course.id) }}" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-colors flex items-center font-medium">
                <i class="ri-pencil-line mr-2"></i> Add/Edit Results
            </a>
            {% endif %}
            <a href="{{ url_for('results.index') }}" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors flex items-center font-medium">
                <i class="ri-arrow-left-line mr-2"></i> Back
            </a>
        </div>
    </div>
</div>

<!-- Course Statistics -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium mb-1">Total Students</p>
                <h3 class="text-3xl font-bold">{{ results|length }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
                <i class="ri-group-line text-3xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium mb-1">Passed</p>
                <h3 class="text-3xl font-bold">{{ results|selectattr('grade', 'in', ['A', 'B', 'C', 'D', 'E'])|list|length }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
                <i class="ri-checkbox-circle-line text-3xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-red-100 text-sm font-medium mb-1">Failed</p>
                <h3 class="text-3xl font-bold">{{ results|selectattr('grade', 'equalto', 'F')|list|length }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
                <i class="ri-close-circle-line text-3xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-100 text-sm font-medium mb-1">Average Score</p>
                <h3 class="text-3xl font-bold">
                    {% if results|length > 0 %}
                        {{ "%.1f"|format(results|sum(attribute='total_score') / results|length) }}
                    {% else %}
                        0
                    {% endif %}
                </h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
                <i class="ri-line-chart-line text-3xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Grade Distribution -->
<div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
    <div class="bg-gradient-to-r from-slate-50 to-slate-100 px-6 py-4 border-b border-slate-200">
        <h5 class="text-lg font-bold text-gray-900 flex items-center">
            <i class="ri-bar-chart-fill mr-2 text-blue-600"></i> Grade Distribution
        </h5>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            {% set grades = ['A', 'B', 'C', 'D', 'E', 'F'] %}
            {% for grade in grades %}
            {% set count = results|selectattr('grade', 'equalto', grade)|list|length %}
            {% set percentage = (count / results|length * 100) if results|length > 0 else 0 %}
            <div class="text-center">
                <div class="mb-3 p-6 rounded-xl {{ 'bg-gradient-to-br from-green-500 to-green-600' if grade in ['A', 'B'] else 'bg-gradient-to-br from-yellow-400 to-yellow-500' if grade in ['C', 'D'] else 'bg-gradient-to-br from-gray-400 to-gray-500' if grade == 'E' else 'bg-gradient-to-br from-red-500 to-red-600' }} text-white shadow-lg">
                    <h3 class="text-4xl font-bold mb-0">{{ grade }}</h3>
                </div>
                <p class="text-lg font-bold text-gray-900 mb-1">{{ count }}</p>
                <p class="text-sm text-gray-500">{{ "%.1f"|format(percentage) }}%</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="bg-gradient-to-r from-slate-50 to-slate-100 px-6 py-4 border-b border-slate-200">
        <div class="flex justify-between items-center">
            <h5 class="text-lg font-bold text-gray-900 flex items-center">
                <i class="ri-table-line mr-2 text-blue-600"></i> Student Results
            </h5>
            <div class="relative">
                <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchResults" class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="Search..." style="width: 200px;">
            </div>
        </div>
    </div>
    <div class="p-6">
        {% if results %}
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200" id="resultsTable">
                <thead class="bg-gradient-to-r from-gray-800 to-gray-900">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">S/N</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Matric Number</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Student Name</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">CA (30)</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Exam (70)</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Total (100)</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Grade</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Grade Point</th>
                        <th class="px-6 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for result in results %}
                    <tr class="{{ 'bg-yellow-50' if result.is_carryover else 'hover:bg-gray-50' }} transition-colors">
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">{{ loop.index }}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-900">{{ result.student.matric_number }}</span>
                                {% if result.is_carryover %}
                                <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded text-xs font-bold" title="Carryover">CO</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-medium">{{ result.student.full_name }}</td>
                        <td class="px-4 py-4 text-center text-sm text-gray-700">{{ "%.1f"|format(result.ca_score) if result.ca_score else '-' }}</td>
                        <td class="px-4 py-4 text-center text-sm text-gray-700">{{ "%.1f"|format(result.exam_score) if result.exam_score else '-' }}</td>
                        <td class="px-4 py-4 text-center text-lg font-bold text-gray-900">{{ "%.1f"|format(result.total_score) if result.total_score else '-' }}</td>
                        <td class="px-4 py-4 text-center">
                            <span class="px-3 py-1 {{ 'bg-green-100 text-green-800' if result.grade in ['A', 'B'] else 'bg-yellow-100 text-yellow-800' if result.grade in ['C', 'D'] else 'bg-gray-100 text-gray-800' if result.grade == 'E' else 'bg-red-100 text-red-800' }} rounded-full text-sm font-bold">
                                {{ result.grade or '-' }}
                            </span>
                        </td>
                        <td class="px-4 py-4 text-center text-sm font-medium text-gray-700">{{ result.grade_point if result.grade_point is not none else '-' }}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center gap-2">
                                {% if result.is_locked and not current_user.is_hod() %}
                                <button class="px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed text-sm font-medium" title="Locked - HoD Only" disabled>
                                    <i class="ri-lock-line"></i>
                                </button>
                                {% else %}
                                <button class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium" onclick="editResult({{ result.id }}, {{ result.ca_score or 0 }}, {{ result.exam_score or 0 }})" title="Edit">
                                    <i class="ri-edit-line"></i>
                                </button>
                                <button class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium" onclick="deleteResult({{ result.id }})" title="Delete">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="flex flex-col items-center">
                <i class="ri-file-list-line text-7xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 font-medium text-lg">No results found for this course</p>
                <a href="{{ url_for('results.manual_entry', course_id=course.id) }}" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center font-medium">
                    <i class="ri-add-line mr-2"></i> Add Results
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div x-data="{ open: false, resultId: null, caScore: 0, examScore: 0 }" 
     @open-edit-modal.window="open = true; resultId = $event.detail.resultId; caScore = $event.detail.caScore; examScore = $event.detail.examScore"
     x-show="open"
     x-cloak
     class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
     @click.self="open = false"
     style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all" @click.stop>
        <form method="POST" :action="`/results/edit/${resultId}`">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 rounded-t-xl">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <i class="ri-edit-line mr-2"></i> Edit Result
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">CA Score (0-30)</label>
                    <input type="number" 
                           name="ca_score" 
                           x-model="caScore"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                           min="0" max="30" step="0.1"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Exam Score (0-70)</label>
                    <input type="number" 
                           name="exam_score" 
                           x-model="examScore"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                           min="0" max="70" step="0.1"
                           required>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end gap-3">
                <button type="button" 
                        @click="open = false"
                        class="px-5 py-2.5 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl font-medium">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div x-data="{ open: false, resultId: null }" 
     @open-delete-modal.window="open = true; resultId = $event.detail.resultId"
     x-show="open"
     x-cloak
     class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
     @click.self="open = false"
     style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all" @click.stop>
        <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4 rounded-t-xl">
            <h3 class="text-xl font-bold text-white flex items-center">
                <i class="ri-alert-line mr-2"></i> Confirm Delete
            </h3>
        </div>
        <div class="p-6">
            <p class="text-gray-900 font-medium mb-2">Are you sure you want to delete this result?</p>
            <p class="text-gray-500 text-sm">This action cannot be undone.</p>
        </div>
        <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end gap-3">
            <button type="button" 
                    @click="open = false"
                    class="px-5 py-2.5 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                Cancel
            </button>
            <a :href="`/results/delete/${resultId}`" 
               class="px-6 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg hover:from-red-700 hover:to-red-800 transition-all shadow-lg hover:shadow-xl font-medium flex items-center">
                <i class="ri-delete-bin-line mr-2"></i> Delete
            </a>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
document.getElementById('searchResults').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll('#resultsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
});

// Edit result - dispatch custom event for Alpine.js modal
function editResult(resultId, caScore, examScore) {
    window.dispatchEvent(new CustomEvent('open-edit-modal', {
        detail: { resultId, caScore, examScore }
    }));
}

// Delete result - dispatch custom event for Alpine.js modal
function deleteResult(resultId) {
    window.dispatchEvent(new CustomEvent('open-delete-modal', {
        detail: { resultId }
    }));
}
</script>
{% endblock %}